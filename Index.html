<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; background-color: #f5f5f5; color: #333; max-width: 400px; margin: 0 auto; padding: 20px; }
      h2 { text-align: center; color: #4285f4; }

      /* å¡ç‰‡æ ·å¼ */
      .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
      .card-content { flex: 1; min-width: 0; }
      .account-name { font-size: 14px; color: #666; font-weight: 500; }
      .otp-code { font-size: 24px; font-family: monospace; color: #4285f4; font-weight: bold; letter-spacing: 2px; }
      .delete-btn { color: #ff4444; cursor: pointer; font-size: 24px; width: 30px; height: 30px; padding: 0; margin-left: 10px; border: none; background: none; flex-shrink: 0; }

      /* è¾“å…¥åŒºåŸŸ */
      .input-group { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
      input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
      button { width: 100%; padding: 10px; background-color: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
      button:hover { background-color: #357abd; }

      /* è¿›åº¦æ¡ */
      .progress-bar { height: 4px; background-color: #e0e0e0; margin-bottom: 20px; border-radius: 2px; overflow: hidden; }
      .progress-fill { height: 100%; background-color: #4285f4; width: 100%; transition: width 1s linear; }

      .loader { text-align: center; margin-top: 20px; color: #888; }
      .error-msg { background: #ffebee; color: #c62828; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 14px; }
    </style>
  </head>
  <body>
    <h2>ğŸ” Web Authenticator</h2>

    <div class="progress-bar">
      <div id="progress" class="progress-fill"></div>
    </div>

    <div id="code-list">
      <div class="loader">æ­£åœ¨åŠ è½½éªŒè¯ç ...</div>
    </div>

    <hr style="border: 0; border-top: 1px solid #ddd; margin: 20px 0;">

    <div class="input-group">
      <h3>æ·»åŠ æ–°è´¦å·</h3>
      <input type="text" id="new-name" placeholder="è´¦å·åç§° (å¦‚: Google, Github)">
      <input type="text" id="new-secret" placeholder="å¯†é’¥ (Base32 Key, å¦‚: JBSWY...)" autocomplete="off">
      <button onclick="addAccount()">æ·»åŠ </button>
    </div>

    <script>
      let isRefreshing = false;  // é˜²æ­¢å¹¶å‘è¯·æ±‚
      let lastRefreshTime = 0;   // è®°å½•ä¸Šæ¬¡è¯·æ±‚æ—¶é—´
      const MIN_REFRESH_INTERVAL = 25000; // æœ€å°è¯·æ±‚é—´éš” 25ç§’

      // é¡µé¢åŠ è½½åç«‹å³è·å–
      window.onload = function() {
        refreshCodes();
        startTimer();
      };

      // å®šæ—¶åˆ·æ–°é€»è¾‘
      function startTimer() {
        setInterval(() => {
          const epoch = Math.floor(Date.now() / 1000);
          const seconds = epoch % 30;
          const remaining = 30 - seconds;

          // æ›´æ–°è¿›åº¦æ¡
          const percentage = (remaining / 30) * 100;
          document.getElementById('progress').style.width = percentage + '%';

          // åªåœ¨å‰©ä½™1ç§’æ—¶åˆ·æ–°ï¼ˆé¿å…åœ¨è¾¹ç•Œé‡å¤è§¦å‘ï¼‰
          if (remaining === 1) {
            refreshCodes();
          }
        }, 1000);
      }

      // ä»åç«¯è·å–æ•°æ®ï¼ˆå¸¦é˜²æŠ–å’Œé”™è¯¯å¤„ç†ï¼‰
      function refreshCodes(force = false) {
        const now = Date.now();

        // é˜²æ­¢å¹¶å‘è¯·æ±‚
        if (isRefreshing) {
          console.log('è¯·æ±‚è¿›è¡Œä¸­ï¼Œè·³è¿‡æœ¬æ¬¡åˆ·æ–°');
          return;
        }

        // é˜²æ­¢è¯·æ±‚è¿‡äºé¢‘ç¹ï¼ˆé™¤éå¼ºåˆ¶åˆ·æ–°ï¼‰
        if (!force && now - lastRefreshTime < MIN_REFRESH_INTERVAL) {
          console.log('è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè·³è¿‡æœ¬æ¬¡åˆ·æ–°');
          return;
        }

        isRefreshing = true;
        lastRefreshTime = now;

        google.script.run
          .withSuccessHandler(function(data) {
            renderCodes(data);
            isRefreshing = false;
          })
          .withFailureHandler(function(error) {
            console.error('è·å–éªŒè¯ç å¤±è´¥:', error);
            isRefreshing = false;

            // å¦‚æœæ˜¯ 429 é”™è¯¯ï¼Œå»¶é•¿ä¸‹æ¬¡è¯·æ±‚æ—¶é—´
            if (error.message && error.message.includes('429')) {
              lastRefreshTime = Date.now();
              console.log('æ£€æµ‹åˆ°é¢‘ç‡é™åˆ¶ï¼Œå°†å»¶è¿Ÿä¸‹æ¬¡è¯·æ±‚');
            }

            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            showError('æ— æ³•è·å–éªŒè¯ç : ' + error.message);
          })
          .getCodes();
      }

      // æ¸²æŸ“åˆ—è¡¨
      function renderCodes(data) {
        const container = document.getElementById('code-list');
        if (data.length === 0) {
          container.innerHTML = '<div class="loader">æš‚æ— è´¦å·ï¼Œè¯·åœ¨ä¸‹æ–¹æ·»åŠ ã€‚</div>';
          return;
        }

        let html = '';
        data.forEach(item => {
          if (item.code === "Error") {
            // æ˜¾ç¤ºé”™è¯¯çš„è´¦å·
            html += `
              <div class="card" style="border-left: 3px solid #ff4444;">
                <div class="card-content">
                  <div class="account-name">${item.name}</div>
                  <div style="color: #ff4444; font-size: 14px;">å¯†é’¥é”™è¯¯æˆ–æ ¼å¼ä¸æ­£ç¡®</div>
                </div>
                <button class="delete-btn" onclick="deleteAccount('${item.name}')">&times;</button>
              </div>
            `;
          } else {
            // æ ¼å¼åŒ– 123456 -> 123 456
            const formatted = item.code.slice(0,3) + ' ' + item.code.slice(3);
            html += `
              <div class="card">
                <div class="card-content">
                  <div class="account-name">${item.name}</div>
                  <div class="otp-code">${formatted}</div>
                </div>
                <button class="delete-btn" onclick="deleteAccount('${item.name}')">&times;</button>
              </div>
            `;
          }
        });
        container.innerHTML = html;
      }

      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      function showError(message) {
        const container = document.getElementById('code-list');
        container.innerHTML = '<div class="error-msg">' + message + '</div>' + container.innerHTML;
      }

      // æ·»åŠ è´¦å·
      function addAccount() {
        const name = document.getElementById('new-name').value.trim();
        const secret = document.getElementById('new-secret').value.trim();

        if(!name || !secret) {
          alert("è¯·å¡«å†™åç§°å’Œå¯†é’¥");
          return;
        }

        const btn = document.querySelector('button');
        btn.textContent = 'æ·»åŠ ä¸­...';
        btn.disabled = true;

        google.script.run
          .withSuccessHandler(() => {
            document.getElementById('new-name').value = '';
            document.getElementById('new-secret').value = '';
            btn.textContent = 'æ·»åŠ ';
            btn.disabled = false;
            refreshCodes(true);  // å¼ºåˆ¶åˆ·æ–°
          })
          .withFailureHandler((e) => {
            alert("é”™è¯¯: " + e.message);
            btn.textContent = 'æ·»åŠ ';
            btn.disabled = false;
          })
          .addAccount(name, secret);
      }

      // åˆ é™¤è´¦å·
      function deleteAccount(name) {
        if(confirm('ç¡®å®šè¦åˆ é™¤ ' + name + ' å—?')) {
          google.script.run
            .withSuccessHandler(() => refreshCodes(true))  // å¼ºåˆ¶åˆ·æ–°
            .withFailureHandler((e) => {
              alert("åˆ é™¤å¤±è´¥: " + e.message);
            })
            .deleteAccount(name);
        }
      }
    </script>
  </body>
</html>
